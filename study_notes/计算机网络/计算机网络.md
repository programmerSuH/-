# 计算机网络概述



## 定义

将地理上分散的、具有独立工作能力的多台计算机通过通信设备和通信线路连接起来，在配有相应的网络通信软件条件下，实现数据通信、资源共享的系统



应用层 （http、ftp、smtp、pop3）交换应用报文

传输层 （tcp、udp）进程到进程

网络层 （ip，负责路由+转发）端到端

数据链路层和局域网（交换机）



> 什么是Internet？

网络：节点+边

计算机网络：联网的计算机构成的系统

​	组成：

​		节点：

​			主机节点

​			数据交换节点（根据层级不同，可分为路由器、交换机等）

​		边：

​			接入链路：连接主机节点和数据交换节点

​			骨干链路：连接数据交换节点

互联网：

​	以tcp、ip协议为主的一簇协议来支撑工作的网络

​	 从服务的角度：分布式应用、通信基础设施



> 什么是协议？

支撑互联网工作的标准

协议的定义：对等层实体在通信过程当中应该遵守的规则的集合，包括了「<font color=blue font-family=bold>**语法**</font>」、「<font color=blue font-family=bold>**语义**</font>」和「<font color=blue font-family=bold>**时序**</font>」

协议的作用：定义了在两个或多个通信实体之间交换的报文格式和次序，以及在报文传输和接收或其他方面所采取的动作





## 组成

> 网络边缘

网络边缘构成：主机、应用程序设备（客户端、服务器）

数据交换模式

- 客户端、服务器模式
- 对等（peer-peer）模式



网络边缘采用网络设置的**面向连接**服务



> 网络核心

分组交换 -- 资源共享

- 使用存储-转发模式

线路交换 -- 独享资源

- 时分
- 波分
- 频分



网络核心功能：

路由：决定分组采用的源到目标的路径

转发：将分组从路由器的输入链路转移到输出链路



> 接入网、物理媒介

接入网

- DSL
- 线缆网络



物理媒介

- 导引型媒体 -- 信号沿着固体媒介被导引（光纤、双绞线、同轴电缆）
- 非导引型媒体 -- 信号自由传播（无线电）



> Internet/ISP结构
>

ISP（Internet Service Provider）互联网服务提供商

ICP（Internet Content Provider，如：Google、Microsoft）互联网内容提供商

IXP（Internet Exchange Point），不同电信运营商之间为连通各自网络二建立的集中交换平台



> 性能：丢包、延时、吞吐量
>

分组丢失和延时的原因：

- 分组到达路由器的速率超过了链路输出的能力
- 分组等待队头被传输



四种分组延时

1. 处理延时
2. 排队延时
3. 传输延时
   - L（bit）：传输的bit数
   - R（bps）：链路带宽，表示单位时间传输bit数
   - L/R为传输延时
4. 传播延时



## 参考模型

> 协议层次、服务模型
>

服务：底层实体向上层实体提供他们之间的通信的能力

服务访问点SAP（Services Access Point）：上层使用下层提供的服务通过层间的接口

原语：上层使用下层服务的形式



**Internet协议栈**

应用层：为人类或其他应用进程提供网络应用服务

传输层：进程到进程的区分、可靠数据传输

网络层：传输以分组为单位的端到端的数据

数据链路层：在相邻两点之间，传输以帧为单位的数据

物理层



### **ISO/OSI参考模型**

应用层

表示层：允许应用解释传输的数据

会话层：数据交换的同步、检查点、恢复

传输层

网络层

链路层

物理层



**各个层次的协议数据单元**

应用层：报文（message）

传输层：报文段（segment）

网络层：分组（packet），无连接的方式：数据报（datagram）

数据链路层：帧（frame）

物理层：位（bit）



# 应用层

网络应用的体系结构：

客户端-服务器模式：CS架构

对等模式：P2P模式

混合体模式：CS+P2P



## 应用层协议原理

> 应用层协议需要解决的问题

1、标识进程

对进程进行编址，进程接收报文，需要一个标识SAP，SAP包括了：

- 主机IP
- 采用的传输层协议：TCP、UDP
- 端口号



2、传输层提供的服务--穿过层间的信息

层间接口必须携带的信息

- 报文
- 应用进程标识
- 对方的应用进程标识



传输层实体根据这些信息进行TCP、UDP报文段的封装

- 源端口号、目标端口号等
- 源IP、目标IP



3、如何使用传输层提供的服务实现应用

- 定义应用层协议
- 编制程序



> Socket

TCP Socket：

- TCP服务：两个进程之间通信之前要建立连接
- 可以用一个整数表示两个应用实体之间的通信关系，从而使得穿过层间的信息量减少
- TCP Socket：源IP、源端口、目标IP、目标端口



UDP Socket：

- UDP服务：两个进程之间通信无需建立连接
- UDP Socket：本IP、本端口





## Web和HTTP

> 术语
>

Web页：含有一个基本的html文件，该html文件还包含若干对象的引用，引用实现方式为url



> HTTP

HTTP（HyperText Transfer Protocol）：超文本传输协议

| HTTP方法 | 作用                             |
| -------- | -------------------------------- |
| POST     | 增 -- 向服务器提交数据           |
| DELETE   | 删 -- 删除服务器的某些资源       |
| PUT      | 改 -- 修改服务器数据             |
| GET      | 查 -- 对服务器资源获取的简单请求 |
| HEAD     | 请求页面的首部，获取资源的元信息 |



HTTP是无状态的



## Email

> 概述

电子邮件组成部分：

- 信封

- 内容（包含首部和主体）



邮件内容的首部包含一些首部行（关键字：内容）。

关键字：

- To：必需的关键字，后面填入一个或多个收件人的电子邮件地址。（电子邮件地址的规定格式为:收件人邮箱名@邮箱所在主机的域名）


- Subject：可选关键字，是邮件的主题，反映了邮件的主要内容


- From：关键字必填，但它通常由邮件系统自动填入




> 组成部分

3个主要组成部分：

- 客户代理
- 邮件服务器
- 简单邮件传输协议：SMTP



![在这里插入图片描述](https://img-blog.csdnimg.cn/cb37c947d41e44c5ba95c35a7a86c299.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAUGFyYW5vaWTimIY=,size_20,color_FFFFFF,t_70,g_se,x_16)



> SMTP协议

SMTP规定在两个相互通信的SMTP进程之间应如何交换信息



传输的3个阶段：

1. 建立连接
2. 邮件传送
3. 释放连接



命令、响应交互模式：

- 命令：ASCII文本
- 响应：状态代码和语句



> POP3协议

POP（Post Office Protocol）

POP3协议时邮件访问协议，从服务器获取邮件



POP两种工作方式：

- 下载并保留
- 下载并删除



## DNS

> 主要目的

- 实现主机名-IP地址的转换

- 负载均衡



> 思路

- 分层、基于域的命名机制
- 在网络边缘处理复杂性





## CDN

全网部署缓存节点，存储服务内容，就近为用户提供服务



## Sokcet编程

### TCP套接字编程

TCP服务：提供可靠的、字节流的服务



### UDP套接字编程

提供不可靠的、UDP数据报服务





# 传输层



> 传输服务

目标：提供高效、可靠、成本有效的数据传输服务

传输实体的实现方式可以有多种：

- 操作系统内核
- 链接库（绑定到网络应用中）
- 独立的用户进程
- ...



> 传输服务原语

基本传输原语

- listen -- 阻塞直到某个进程发送连接请求
- connect -- 主动尝试建立连接
- send -- 发送信息
- receive -- 阻塞直到接收一个data包
- disconnect -- 请求释放连接



中断连接的方式

- 对称：一方执行disconnect，表示它当前无数据要发送，但仍接收对方发送的数据，直到对方发送disconnect请求才真正释放连接
- 非对称：任何一方发送disconnect原语，当该传输段到达对方时，连接就被释放了



> 传输协议要素

寻址



> 建立连接

建立连接需要解决网络可能出现的丢失、延迟、损坏和重复数据包的问题



解决方法：

设置数据包的生存期，使用以下一种或多种技术将生存期限定在一个最大值内：

1. 限制网络设计
2. 在每个数据包中放置跳计数器
3. 为每个时间包打上时间戳（需要同步所有路由器的时钟）









## 多路复用/解复用

> 多路复用

多路复用对应发送方

从多个套接字接收来自多个进程的报文，根据套接字对应的IP地址和端口号等信息对报文段头部加以封装



> 多路解复用

多路解复用对应接收方

根据报文段的头部信息中的IP地址和端口号将接收到的报文段发给对应的套接字和对应的应用进程



## UDP

UDP应用场景：

- 流媒体（速率敏感、丢失部敏感）
- DNS
- SNMP



> UDP校验和

目的：检测在被传输报文段中的差错



发送方：

将报文段的内容视为16bit的整数

校验和：报文段的加法和

发送方将校验和放在UDP校验和字段



接收方：

计算接收到的报文段的校验和

检查计算出的校验和与校验和字段的内容是否相等：

- 相等 -- 没有检测到差错，但可能有残存错误
- 不相等 -- 检测到错误





> 回卷校验和

当数字相加时，最高位的进位要回卷，再加到结果上

最后求出的和求反得到校验和



目标端：

校验范围+校验和=1111111111111111，则通过校验，否则没有通过校验







## 可靠传输原理

可靠数据传输：rdt

假设下层传输从可靠一步步到不可靠，如何解决每一步不可靠产生的问题

使用有限状态机（fsm）来描述状态变化过程



> rdt1.0

下层的信道完全可靠

- 无bit出错
- 无分组丢失



发送方和接收方FSM：

- 发送方将数据发送到下层信道
- 接收方从下层信道接收数据



> rdt2.0

下层信道可能会出错：将分组中的比特翻转

- 用==校验和==来检测bit差错



新机制：采用差错控制编码进行差错检测

- 发送方差错控制编码、缓存
- 接收方使用编码检错
- 接收方反馈：控制报文（ACK、NAK）发送给发送方
- 发送方收到反馈采取相应措施





> rdi2.1

如果ACK/NAK出错，发送方不知道接收方发生了什么事情，怎么办？

发送方如果重传，可能导致重复

不重传，可能死锁或出错



此时，引入新的机制：**==序号==**



处理重复：

- 发送方在每个分组中加入序号
- 如果ACK/NAK出错，发送方重传当前分组
- 接收方丢弃重复分组



停等协议：发送方发送一个分组，然后等待接收方的应答



> rdt2.2

无NAK的协议



- 功能同rdt2.1，但只使用ACK
- 对当前分组的反向确认用前一分组的正向确认来代替



> rdt3.0

具有bit差错和分组丢失的信道



新的信道可能会丢失分组

- 造成死锁



引入新的机制：==超时重传==



> 滑动窗口（SW）协议

一次只发送一个信包，链路利用率低，因此需要发送多个协议

流水线协议：允许发送方在未得到对方确认的情况下一次发送多个分组

- 必须增加序号的范围：用多个bit表示分组的序号
- 在发送方和接收方要有缓冲区
  - 发送方缓冲：未得到确认，可能需要重传
  - 接收方缓冲：上层用户取数据的速率~接收到的数据速率
- 两种通用的流水线协议：回退N步（GBN）和选择重传（SR） 



发送缓冲区

- 内存中的区域，落入缓冲区的分组可以发送
- 需要重发时可用
- 发送缓冲区的大小
  - 停止等待协议=1
  - 流水线协议>1



发送缓冲区和发送窗口

- 发送缓冲区：准备发送或已发送但未经确认的区域
- 发送窗口：已发送但但未经确认的区域



接收窗口=接收缓冲区

- 接收窗口WR=1，只能顺序接收
- WR>1，乱序接收

| 发送方窗口大小 | 接收方窗口大小 | 协议                |
| -------------- | -------------- | ------------------- |
| 1              | 1              | 停止等待协议（S-W） |
| >1             | 1              | GBN                 |
| >1             | >1             | SR                  |





## TCP

TCP：提供可靠的字节流服务

- 点对点
  - 一个发送方、一个接收方
- 可靠的、按顺序的字节流
- 管道化（流水线）
- 发送和接收缓存
- 全双工数据
  - 在同一连接中数据流双向流动
- 面向连接
  - 在数据交换之前，通过握手初始化发送方、接收方的状态变量
- 流量控制





### 超时重传

> 序号、确认号

序号：报文段首字节在字节流的编号

确认号：期望从另一方收到的下一个字节的序号





> 往返延时和超时

$EstimatedRTT=(1-\alpha) * EstimatedRTT + \alpha * SampleRTT$

$DevRTT = (1-\beta) * DevRTT + \beta * |SampleRTT - EstimatedRTT|$

$TimeoutInterval = EstimatedRTT + 4 * DevRTT$





> 快速重传

超时周期往往太长

通过重复的ACK来检测报文段丢失

如果发送方收到同一数据的3个冗余ACK，重传最小序号的段







### 流量控制

接收方在其向发送方的TCP段头部的rwnd字段通告其空闲buffer大小

- RecBuffer大小通过socket选项设置

保证接收方不会被淹没



### 连接管理

> 建立连接

在正式交换数据之前，发送方和接收方握手建立通信关系：

- 同意建立连接
- 同意连接参数



> 关闭连接

客户端、服务端分别关闭它自己一侧的连接

- 发送FIN bit=1的TCP段

一旦接收到FIN，用ACK回应





## 拥塞控制

> 拥塞控制原理

拥塞：

非正式定义：太多数据需要网络传输，超过了网络的处理能力

拥塞的表现

- 分组丢失（路由器缓冲区溢出）
- 分组经历比较长的延迟（在路由器的队列中排队）



> 拥塞的代价

为了达到一个有效输出，网络需要做更多的工作（重传）

网络拥塞，导致传输速度慢，触发了超时重传机制，造成链路中包括了多个分组的拷贝的情况 





> 拥塞控制机制

- 路由器不向主机发送有关拥塞的反馈信息
  - 路由器的负担较轻
  - 符合网络核心简单的TCP/IP架构原则
- 端系统根据自身得到的信息，判断是否发生拥塞，采取相应动作





如何探测拥塞？

- 某个段超时：<font color=red>拥塞</font>
- 收到某个段3次重复ACK：<font color=red>轻微拥塞</font>





如何控制发送端发送的速率？

- 超时或3个重复ACK，CongWin
  - 超时：CongWin降为1MSS，进入SS阶段后倍增到CongWin/2，从而进入CA阶段
  - 3个重复ACK：CongWin降为CongWin/2，CA阶段
- 正常收到ACK
  - SS阶段（慢启动）：加倍增加
  - CA阶段（拥塞避免）：线性增加



> 拥塞控制策略

- 慢启动
- AIMD：线性增、乘性减少
- 超时事件后的保守策略



- 当CongWin < Threshold，发送端处于慢启动阶段，窗口指数型增长
- 当CongWin > Threshold，发送端处于拥塞避免阶段，窗口线性增加
- 当收到3个重复的ACK，Threshold设置成CongWin / 2，CongWin=Threshold+3
- 当超时事件发生时，Threshold=CongWin/2，CongWin=1MSS，进入SS阶段







# 网络层

- 导论
  - 数据平面
  - 控制平面
- 路由器组成
- IP协议
  - 数据报格式
  - 分片
  - IPv4
  - NAT
  - IPv6
- 通用转发和SDN
  - 匹配
  - 行动



> 网络层功能

转发（局部概念）：

- 概念：将分组从路由器的输入接口转发到合适的输出接口
- 功能：
  - 传统方式：基于目标地址+转发表
  - SDN方式：基于多个字段+流表



路由（全局概念）：

使用路由算法来决定分组从发送主机到目标接收主机的路径

 

> 路由器

- 通过内存交换
- 通过总线交换
- 通过互联网络的交换





> 调度机制

调度：选择下一个要通过链路传输的分组

- FIFO（first in first out）：先来先服务
- 优先权调度
- Round Robin：循环扫描不同类型的队列，轮流发送一类中的一个分组
- Weighted Fair Queuing ：加权控制队列







## IP协议

实现功能：

- 地址约定
- 数据报格式
- 分组处理约定





> 子网

什么是子网：

- 一个子网内的节点，它们IP地址的高位部分相同，这些节点构成的网络的一部分叫做子网
- 无需路由器介入，子网内各主机可以在物理上相互直接到达





> IP地址分类

- A类网络：0开头，7bit表示网络（126个，除了全0和全1），24bit表示主机
- B类网络：10开头，14bit表示网络（16382个），16bit表示主机
- C类地址：110开头，21bit表示网络，8bit表示主机
- D类地址：1110开头
- E类地址：11110开头



特殊IP地址

- 子网部分全为0 -- 本网络
- 主机部分全为0 -- 本主机
- 主机部分全为1 -- 广播地址





内网（专用）IP地址

- 专用地址：地址空间的一部分供专用地址使用
- 永远不会被当作公用地址来分配，不会与公用地址重复
- 路由器不对目标地址是专用地址的分组进行转发
- 专用地址范围：
  - A类地址 ：10.0.0.0-10.255.255.255 MASK 255.0.0.0
  - B类地址：172.16.0.0-172.31.255.255 MASK 255.255.0.0
  - C类地址：192.168.0.0-192.168.255.255 MASK 255.255.255.0





> IP编址：CIDR

CIDR：Classless InterDomain Routing（无类域间路由）

- 子网部分可以在任意的位置
- 地址格式a.b.c.d/x，其中x是地址中子网号的长度





## DHCP

> IP地址分配

主机如何获得一个IP地址：

- 系统管理员将地址配置在一个文件中
- DHCP（Dynamic Host Configuration Protocol）：从服务器中动态获得一个IP地址



> DHCP

目标：允许主机在加入网络的时候，动态地从服务器那里获得IP地址

- DHCP请求被封装在UDP段中，封装在以太网地帧中
- 以太网帧在局域网范围内广播，被运行DHCP服务的路由器收到
- 以太网帧解封装成IP、IP解封装成UDP、解封装成DHCP



##  NAT

> NAT

NAT（Network Address Translation）：网络地址转换

 

本地网络只有一个有效IP地址：

- 不需要从ISP分配一块地址，可用一个IP地址用于所有的局域网设备
- 可以在局域网改变设备的地址的情况下无需通知外界
- 可以改变ISP而不需要改变内部的设备地址
- 局域网的内部的设备没有明确的地址，对外是不可见的，更加安全





NAT路由器实现功能：

- 外出数据包：替换源地址和端口号为NAT IP地址和新的端口号，目标IP和端口号不变
- 记住每个转换替换对
- 进入数据包：替换





> NAT争议

- 路由器应只对第3层做信息处理，而这里对端口号（第4层）做了处理
- 违反了end-to-end原则
- NAT穿越：如果客户端需要连接在NAT后面的服务器，应如何操作





> NAT穿越

客户端需要连接地址为10.0.0.1的服务器

- 服务器地址10.0.0.1 LAN本地地址
- 整网只有一个外部可见的地址：138.76.29.7



方案1：

静态配置NAT：转发进来的服务器特定端口连接请求



方案2：

UPnP（Universal Plug and Play）Internet Gateway Device（IGD）协议：

- 允许NATted主机获知网络的公共IP地址
- 列举存在的端口映射
- 增删端口映射





方案3：

中继

- NAT后面的服务器建立和中继的连接
- 外部的客户端链接到中继
- 中继在2个连接之间桥接





## SDN

> 主要思路

网络设备数据平面和控制平面分离

数据平面-分组交换机

- 将路由器、交换机和目前大多数网络设备的功能进一步抽象成：按照流表（由控制平面设置的控制逻辑）进行PDU（帧、分组）的动作（包括转发、丢弃、拷贝、泛洪、阻塞）
- 统一化设备功能：SDN交换机、执行控制逻辑

控制平面-控制器+网络应用

- 分离、集中
- 计算和下发控制逻辑：流表



 

> 网络层控制平面

传统路由算法

SDN控制器

ICMP：Internet Control Message Protocol

网络管理





## 路由选择算法



> 路由

路由：按照某种指标（传输延迟、经过的站点数目）找到一条从源节点到目标节点的较好路径



> 路由表

路由表由三元组（M，N，R）

- M：目标网络子网掩码
- N：目标网络
- R：下一个路由器



最优化原则



汇集树（sink tree）

- 此节点到所有其他节点的最有路径形成的树
- 路由选择算法就是为所有路由器找到并使用汇集树





# 数据链路层



数据链路层服务的原理：

- 检错和纠错
- 共享广播信道：多点接入
- 链路层寻址
- LAN：以太网、VLANs
- 可靠数据传输





> 链路层服务

成帧：

- 将数据报封装在帧中，加上帧头、帧尾
- 如果是共享性介质，信道接入获得信道访问权
- 在帧头部使用MAC地址来标示源和目的

在相邻两个节点完成可靠数据传递





## LANs

LAN（Local Area Network）：局域网

MAC（Media Access Control Address）：媒体访问控制地址，也称为局域网地址、以太网地址或物理地址。MAC地址用于在网络中标示一个网卡。





> 网络地址和mac地址分离

IP地址和MAC地址的作用不同

- IP地址是分层的
  - 一个子网所有站点网络号一致，路由聚集，减少路由表
  - 希望网络层地址是配置的
- MAC地址是平面的
  - 网卡在生产时不知道被用于哪个网络，因此给网卡一个唯一的标示，用于区分一个网络内部不同的网卡







> ARP

ARP（Address Resolution Protocol）

- 在LAN上的每个IP节点都有一个ARP表
- ARP表：包括一些LAN节点的IP/MAC地址映射







## 以太网

以太网（Ethernet）：最主流的LAN技术





> 以太网帧结构

发送方适配器在以太网帧中封装IP数据报或其他网络层协议数据单元



- 地址：6字节源MAC地址，目标MAC地址
- 类型：指出高层协议
- CRC：在接收方校验

- 无连接：帧传输之前，发送方和接收方之间没有握手
- 不可靠：接收方不发送ACKs或NAKs给发送方
- 以太网的MAC协议：采用二进制退避的CSMA/CD介质访问控制形式



以太网标准：

- 相同的MAC协议和帧结构
- 不同的物理层标准
- 不同的物理层媒介：光纤、同轴电缆和双绞线



> 交换机

链路层设备：扮演主动角色

- 对帧进行存储和转发
- 对于到来的帧，检查帧头，根据目标MAC地址进行选择性转发
- 当帧需要向某个网段进行转发，需要使用CSMA/CD进行接入控制
- 多路同时传输：对每个帧进入的链路使用以太网协议，没有碰撞：全双工





交换机vs路由器

- 都是存储转发设备，但层次不同
  - 交换机：链路层设备
  - 路由器：网络层设备
- 都有转发表
  - 交换机：维护交换表，按照MAC地址转发
    - 执行过滤、自学习和生成树算法
    - 即插即用
    - ARP表项随着站点数量增多而增多
  - 路由器
    - 路由算法能够避免环路，无需执行生成树算法，可以以各种拓扑构建网络
    - 对广播分组做限制



# 物理层









































