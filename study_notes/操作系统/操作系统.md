# 概述

## 基本概念

> 什么是操作系统

- 用户角度：OS是一个控制软件
- 资源管理角度：OS是资源分配器（管理外设、分配资源）



> 操作系统内核

操作系统组成可以分为Shell和kernel，kernel的作用在于对上层提供服务，而kernel是操作系统的核心部分

kernel-操作系统内核组件，包括：

- CPU调度器
- 物理内存管理
- 虚拟内存管理
- 文件系统管理
- 中断处理与设备驱动



操作系统内核特征：

- 并发管理
- 共享
  - 同时访问
  - 互斥共享
- 虚拟
  - 利用多道程序设计技术，让每个用户觉得有一个计算机专门为他服务
- 异步
  - 程序运行不是一贯到底，二是走走停停，向前推进的速度是不可预知的



> 操作系统的作用

1. 抽象计算机资源

2. 硬件访问和复用

   操作系统内核可以访问与修改硬件资源

3. 隔离性

4. 允许共享

5. 安全性，访问控制

6. 高性能

7. 多用途



## 启动

OS的代码初始放在磁盘中，如果想要启动OS，就需要在开机时存在一种调用，将OS代码从磁盘加载到内存中，使用的加载器就是bootloader

DISK：存放OS和bootloader

BIOS：基本I/O处理系统（在内存中）

- 将Bootloader从磁盘的引导扇区加载到内存中，如0x7c00
- 跳转到CS:IP=0000:7c00

Bootloader：加载OS

- 将操作系统的代码和数据从硬盘加载到内存中
- 跳转到操作系统的起始地址





## 系统调用、中断和异常

- 系统调用（来源于应用程序）
  - 应用程序主动向操作系统发出服务请求

- 中断（来源于外设：如键盘、鼠标、网卡、声卡等）

  - 来自不同硬件设备的计时器和网络的中断

- 异常（来源于不良的应用程序）

  - 非法指令或其他坏的处理状态

  

> 中断

硬件

- 设置中断标记 

软件

- 保存当前处理状态
- 中断服务程序处理
- 清除中断标记
- 恢复之前保存的处理状态



> 异常

- 保存现场
- 异常处理
  - 杀死异常程序
  - 重新执行异常指令
- 恢复现场







# 内存

操作系统管理内存的方法：

- 程序重定位
- 分段
- 分页
- 虚拟内存
- 按需分页虚拟内存



## 内存分配

### 动态分配策略

- 首次适配：每次将第一个适配的内存区域分配出去

- 最优适配：每次将最适配的内存区域分配出去

- 最差适配：每次将最不适配的内存区域分配出去





> 连续内存分配

- 压缩式碎片整理
- 交换式碎片整理





> 非连续内存分配

非连续内存分配方法：

- 分段

- 分页



**分段**

- 程序的分段地址空间
- 分段寻址方案



**分页**

-  划分物理内存至固定大小的帧
- 划分逻辑地址空间至相同大小的页
- 建立方案，转换逻辑地址为物理地址
  - 页表
  - MMU、TLB



> 分页机制性能问题

访问一次内存单元需要2次内存访问

- 一次访问页表
- 一次访问数据

页表可能非常大



解决方法

- 缓存
- 间接访问



TLB（Translation Look-aside Buffer）

- 缓存近期访问的页帧转换表项







## 虚拟内存

虚拟内存=物理内存+磁盘



**页表表项**

<img src="D:\Note\study_notes\操作系统\图片\页表表项.png" width=50% align=left>



驻留位：表示该页是在内存还是外存。驻留位为1，表示该页在内存中，页表项有效；该位为0，表示该页在外存中，访问该页表项会导致缺页中断

保护位：表示允许对该页做何种类型的访问，如只读、可读写、可执行等

修改位：表明此页在内存中是否被修改过，当系统回收该物理页时，根据修改位来决定是否需要将内容写回外存

访问位：表示该页面是否被访问过，用于页面置换算法







### 页面置换算法

> 最优页面置换算法

- 当一个缺页中断发生时，对于保存在内存中的每一个逻辑页面，计算它下次被访问之前需要等待的时间，选择时间最长的作为被置换的页面
- 但这只是一种理想情况，在实际系统中无法实现。可以作为其他算法性能的评价依据 



> 先进先出算法

先进先出算法（First In First Out, FIFO）

基本思路：选择在内存中驻留时间最长的页面替换。

具体实现：系统维护一个链表，记录了所有位于内存中的逻辑页面。从链表的排列顺序看，链表首页面驻留时间最长，当发生缺页中断时，把链表首页面替换，并把新页面添加到链表的末尾

劣势：性能较差，调出的页面可能是经常要访问的页面





> 最近最久未使用算法

最近最久未使用算法（Least Recently Used，LRU）

基本思路：发生缺页中断时，选择最久未使用的页面进行替换

依据：程序的局部性原理

实现方法：

1. 系统维护一个页面链表，最近使用的页面作为首节点，每次访问内存时，找到相应页面，将它从链表中取出，移动到链表之首。发生缺页中断时，淘汰链表末尾页面
2. 设置活动页面栈，每次访问某页面时，将页号压入栈顶，若栈内有相同页号的记录，就将其抽出。发生缺页中断时，总是选择栈底的页面进行替换





> 时钟页面置换算法

基本思路：

- 使用页表项中的访问位，当一个页面被加载到内存中时，把该位初始化为0，如果页面被访问，则将该位设为1
- 将各个页面组织成环形链表，把指针指向最老的页面（最先进来）
- 当发生缺页中断时，考察指针所指向的最老的页面，如果它的访问位为0，则淘汰该页；若访问位为1，则设为0，指针往下移动。如此下去，直到找到被淘汰的页面，然后指针移动到它的下一格



> 最不常用算法

当发生缺页中断时，选择访问次数最少的页面，将其淘汰

实现方式：对每个页面设置一个访问计数器，每当页面被访问，访问计数器+1，发生缺页中断时，淘汰计数器的值最小的页面



# 进程与线程

## 进程

### 概念

> 进程的定义

一个具有一定功能的程序在一个数据集合上的一次动态执行过程



> 进程的组成

一个进程包括：

- 程序代码
- 程序处理的数据
- 程序计数器
- 通用寄存器的值、堆、栈
- 一组系统资源



进程与程序的区别：

- 进程是动态的；程序是静态的
- 程序是有序代码的集合；进程是程序的执行





>  进程的特点

动态性：可动态创建、结束进程

并发性：进程可以被独立调度并占用处理机运行

独立性：不同进程工作互不影响

制约性：访问共享数据、资源或进程间同步产生制约





> 进程控制块

描述进程的数据结构：进程控制块（Process Control Block，PCB）

进程控制块：操作系统管理控制进程运行所用的信息集合（PCB是进程存在的唯一标志）

组织形式：通过链表进行组织，将具有相同状态的进程串联在一起，组成各种队列

- 将所有就绪状态的进程串联，形成就绪队列
- 将所有等待某事件而处于等待状态的进程串联在一起，形成阻塞队列



PCB含有三大类信息：

1. 进程标识信息：本进程的标识，父进程标识、用户标识

2. 处理及状态信息保存区

   - 用户可见寄存器
   - 控制和状态寄存器（程序计数器 PC，程序状态字）
   - 栈指针

3. 进程控制信息

   - 调度和状态信息：如new、ready、running、waiting、blocked等

   - 进程间通信信息

   - 存储管理信息

   - 进程所用资源

     





### 进程管理

> 进程状态

- 进程的生命期管理
- 进程状态变化模型
- 进程挂起模型





> 进程状态变化模型

进程的三种基本状态：

- 运行状态
- 就绪状态
- 阻塞状态（等待状态）



进程其他基本状态

- 创建状态
- 结束状态 



> 进程挂起

进程在挂起状态时，意味着进程没有占用内存空间。处在挂起状态的进程映像在磁盘上



挂起状态：

- 阻塞挂起状态：进程在外村并等待某事件出现
- 就绪挂起状态：进程在外存，但只要进入内存就可以运行



挂起：把一个进程从内存转到外存

- 阻塞到阻塞挂起
- 就绪到就绪挂起
- 运行到就绪挂起



在外存时的状态转换

- 阻塞挂起到就绪挂起



与挂起相关的状态转换

- 就绪挂起到就绪
- 阻塞挂起到阻塞



> 状态队列

由操作系统来维护一组队列，用来表示系统当中所有进程的当前状态

不同的状态用不同的队列来表示（就绪队列、各种类型的阻塞队列）



## 线程

进程存在的问题：

- 维护进程的系统开销大
- 创建进程，分配资源，创建PCB；撤销进程，回收资源，撤销PCB
- 进程切换，保存当前进程的状态信息



线程解决的问题：

- 实体之间可以并发执行
- 实体之间共享相同的地址空间







> 进程与线程对比

- 进程是资源分配单位，线程是CPU调度单位
- 进程拥有一个完整的资源平台，线程独享必不可少的资源，如寄存器和栈
- 线程能减少并发执行的时间和空间开销
  - 线程的创建时间比进程短
  - 线程的终止时间比进程短
  - 线程切换时间比进程切换时间短





### 线程的实现

三种线程实现方式：

- 用户线程
- 内核线程
- 轻量级进程



> 用户线程

在用户空间实现的线程机制，它不依赖于操作系统的内核，由一组用户级线程库函数来完成线程的管理，包括线程的创建、终止、同步和调度等







## 死锁

死锁只有在同时满足以下四个条件时才会发生：

- 互斥条件
- 持有并等待条件
- 不可剥夺条件
- 环路等待条件



> 互斥条件

多个线程无法同时使用同一个资源



> 持有并等待

A线程持有了资源1，又想申请资源2；资源2被C线程持有，A处于等待状态



> 不可剥夺

当A线程已经持有了资源，在自己使用完之前不能被其他线程获取，B线程如果也想使用此资源，则只能等待A线程使用完并释放资源后才能获取



> 环路等待

两个线程获取资源的顺序构成了环形链





**避免死锁的发生：**

> 打破环路等待

使用资源有序分配法：线程A和线程B获取资源的顺序一样







## 乐观锁与悲观锁



### 互斥锁和自旋锁

锁的底层实现有两种形式：互斥锁和自旋锁

 

> 互斥锁

加锁失败后，线程会释放CPU，给其他线程

互斥锁加锁失败而阻塞是由操作系统内核实现的。加锁失败时，内核会将线程设置为睡眠状态

互斥锁存在一定开销成本，即两次线程上下文切换的成本：

- 线程加锁失败，内核会将线程的状态从运行状态设置为睡眠状态
- 当锁被释放时，睡眠状态的线程会变为就绪状态，然后内核会在合适的时间，把CPU切换给该线程运行



> 自旋锁

加锁失败后，线程会忙等，直到它拿到锁

自旋锁是通过CPU提供的CAS函数（Compare And Swap），在用户态完成加锁和解锁操作，不会产生线程上下文切换



### 乐观锁与悲观锁

互斥锁、自旋锁、读写锁都属于悲观锁

悲观锁认为多线程同时修改共享资源的概率比较高，所以访问共享资源前，先要上锁

但如果多线程同时修改共享资源的概率比较低，就可以采用乐观锁



乐观锁原理：

先修改共享资源，再验证这段时间内有没有发生过冲突，如果没有其他线程在修改资源，则操作完成；否则，放弃本次操作





# 调度算法

## 进程调度算法

常见的调度算法：

- 先来先服务算法（First Come First Service，FCFS）
- 最短作业优先调度算法（Shortest Job First，SJF）
- 高相应比优先调度算法（Highest Response Ratio Next，HRRN）
- 时间片轮转调度算法（Round Robin，RR）
- 最高优先级调度算法（Highest Priority First，HPF）
- 多级反馈队列调度算法（Multilevel Feedback Queue，MFQ）





## 磁盘调度算法

常见的磁盘调度算法：

- 先来先服务算法
- 最短寻道时间优先算法
- 扫描算法
- 循环扫描算法
- LOOK与C-LOOK算法



> 扫描算法

扫描算法：磁头在一个方向上移动，访问所有未完成的请求，直到磁头到达该方向上的最后的磁道，才调换方向，这种算法也叫做电梯算法



> 循环扫描算法

循环扫描（Circular Scan，CSCAN）

只有磁头朝某个特定方向移动时，才处理磁道访问请求，而返回时直接快速移动至最靠边缘的磁道，也就是复位磁头，并且中途不处理任何请求



> LOOK与C-LOOK算法

扫描和循环扫描算法都是磁头移动到磁盘最始端或最末端才开始调换方向

优化方式：磁头移动到最远的请求位置，然后立即反向移动

针对SCAN算法的优化叫LOOK算法；针对CSCAN算法的优化叫C-LOOK算法





# 文件系统



## 概念

文件系统时操作系统中负责管理持久数据的子系统



Linux文件系统会为每个文件分配两个数据结构：索引节点（index node）和目录项（directory entry），它们主要用来记录文件的元信息和目录层次结构

- 索引节点（inode）：用来记录文件的元信息，比如inode编号、文件大小、访问权限、创建时间、修改时间、数据在磁盘的位置等。索引节点是文件的唯一标识，它们之间一一对应，索引节点同样被存储在磁盘中
- 目录项（dentry）：用来记录文件的名字、索引节点指针以及其他目录项的层级关联关系。多个目录项关联起来，就会形成目录结构

- 





> 文件如何存储在磁盘

磁盘读写的最小单位是扇区，每个扇区只有512B大小



磁盘在进行格式化的时候，会被分为三个存储区域：

- 超级块：用来存储文件系统的详细信息，比如块个数、块大小、空闲块等
- 索引节点区：用来存储索引节点
- 数据块区：用来存储文件或目录数据



## 虚拟文件系统

文件系统的种类众多，操作系统希望对用户提供一个统一的接口，于是在用户层与文件系统层引入了中间层，这个中间层就成为虚拟文件系统（Virtual File System，VFS）



> Linux文件系统分类

根据存储位置不同，分为三类：

- 磁盘的文件系统
- 内存的文件系统
- 网络的文件系统：用来访问其他计算机主机数据的文件系统

文件系统首先要挂载到某个目录才可以正常使用，比如Linux系统启动时，会把文件系统挂载到根目录



## 文件的存储

文件的数据是要存储在硬盘上的，数据在磁盘上的存放方式有以下两种：

- 连续空间存放
- 非连续空间存放
  - 链表方式
  - 索引方式



## 空闲空间管理

空闲空间管理机制：

- 空闲表法
- 空闲链表法
- 位图法











